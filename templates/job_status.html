<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Status Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ---------------------- THEME VARIABLES ---------------------- */
        :root {
            --color-primary: #1e88e5; /* Blue */
            --color-primary-hover: #1565c0;
            --color-background: #f0f2f5; /* Light Gray Background */
            --color-surface: #ffffff; /* White Card/Container */
            --color-surface-light: #f9f9f9; /* New light surface */
            --color-text: #212121; /* Dark Text */
            --color-text-secondary: #757575;
            --color-border: #e0e0e0;
            --color-success: #4caf50;
            --color-failure: #e53935;
            --color-warning: #ff9800;
        }
        [data-theme='dark'] {
            --color-primary: #64b5f6;
            --color-primary-hover: #42a5f5;
            --color-background: #0d1117; /* GitHub Dark */
            --color-surface: #161b22; /* Dark Card/Container */
            --color-surface-light: #21262d; /* New light surface for contrast */
            --color-text: #e0e0e0; /* Light Text */
            --color-text-secondary: #bdbdbd;
            --color-border: #303030;
            --color-success: #81c784;
            --color-failure: #e57373;
            --color-warning: #ffb74d;
        }

        /* ---------------------- BASE STYLES & LAYOUT ---------------------- */
        * {
            box-sizing: border-box;
            transition: background-color 0.4s, color 0.4s, border-color 0.4s, box-shadow 0.4s;
            font-family: 'Inter', sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 30px 20px;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 40px;
            background: var(--color-surface);
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            position: relative;
            opacity: 0;
            animation: fadeInContainer 0.8s ease-out forwards;
        }
        @keyframes fadeInContainer {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h1 {
            color: var(--color-text);
            font-weight: 800; /* Increased weight for main title */
            font-size: 2.5em; /* Slightly larger title */
            border-bottom: 3px solid var(--color-primary);
            padding-bottom: 0.5em;
            margin-bottom: 1.5em;
            line-height: 1.2;
        }
        h2 {
            color: var(--color-primary);
            font-size: 1.6em;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0.3em;
            margin-top: 2em;
            margin-bottom: 1em;
            font-weight: 700;
        }
        h3 {
            color: var(--color-text);
            font-weight: 700;
            font-size: 1.2em;
            margin-top: 2em;
            margin-bottom: 1em;
            border-bottom: 1px dashed var(--color-border);
            padding-bottom: 0.3em;
        }
        p {
            line-height: 1.6;
        }

        /* ---------------------- BUTTON STYLES ---------------------- */
        a.button {
            display: inline-block;
            padding: 1em 2em;
            margin-top: 3em;
            border: none;
            border-radius: 8px;
            background-color: var(--color-primary);
            color: var(--color-surface);
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            text-decoration: none;
            font-size: 1em;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 10px rgba(30, 136, 229, 0.3); /* Button shadow */
        }
        a.button:hover {
            background-color: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(30, 136, 229, 0.4);
        }

        /* ---------------------- THEME SWITCH (Optimized Positioning) ---------------------- */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            color: var(--color-text);
            font-size: 0.9em;
        }
        .theme-switch {
            /* ... (Theme switch styles remain the same) ... */
            display: inline-block;
            height: 24px;
            position: relative;
            width: 48px;
            margin-left: 10px;
        }
        .theme-switch input { display: none; }
        .slider {
            background-color: var(--color-text-secondary);
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: var(--color-surface);
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            width: 16px;
            transition: .4s;
        }
        input:checked + .slider { background-color: var(--color-primary); }
        input:checked + .slider:before { transform: translateX(24px); }
        .slider.round { border-radius: 34px; }
        .slider.round:before { border-radius: 50%; }

        /* ---------------------- PROGRESS/RUNNING STATE ---------------------- */
        .running-status h2 {
            border-bottom: none;
            display: flex;
            align-items: center;
            gap: 15px;
            color: var(--color-warning);
            font-size: 2em; /* Larger for focus */
        }
        .running-status .spinner {
            width: 30px; /* Larger spinner */
            height: 30px;
            border: 5px solid var(--color-warning);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite; /* More modern spin animation */
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ---------------------- METRICS CARDS ---------------------- */
        .metrics { 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 2em 0; 
        }
        .metric { 
            padding: 2em; 
            border-radius: 12px; 
            background: var(--color-surface); /* Changed to primary surface for better visibility */
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--color-primary); /* Changed to left border for modern look */
            text-align: left;
            animation: fadeIn 0.8s ease-out;
        }
        .metric h3 { 
            margin: 0; 
            color: var(--color-text-secondary);
            font-size: 1em;
            border-bottom: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .metric .value { 
            font-size: 3.5em; 
            font-weight: 800; 
            color: var(--color-primary);
            line-height: 1.2;
            margin-top: 5px;
        }
        .metric-cracked {
            border-left-color: var(--color-failure); /* Red border for cracked */
        }
        .metric-cracked .value { 
            color: var(--color-failure); 
        } 
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        /* ---------------------- SCORECARD STYLES ---------------------- */
        .scorecard {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 3em 0 2em 0;
            padding: 30px;
            background: var(--color-surface-light);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-left: 10px solid var(--color-primary); /* Wider border */
        }
        .scorecard-score {
            font-size: 5.5em; /* Slightly larger score */
            font-weight: 800;
            line-height: 1;
            margin: 0;
            min-width: 150px; /* Ensures consistent layout */
            text-align: right;
        }
        .scorecard-header {
            flex-grow: 1;
        }
        .scorecard-header h2 {
            margin-top: 0; 
            padding-bottom: 0; 
            border-bottom: none;
        }
        .scorecard-summary {
            text-align: right;
            margin-left: 20px;
        }
        .scorecard-summary p {
            margin: 5px 0;
            font-size: 1.1em;
            color: var(--color-text-secondary);
        }

        /* Conditional Score Colors (Applied by JS) */
        .score-A { border-left-color: var(--color-success); }
        .score-B { border-left-color: var(--color-success); }
        .score-C { border-left-color: var(--color-warning); }
        .score-D, .score-F { border-left-color: var(--color-failure); }
        
        .score-A .scorecard-score, .score-B .scorecard-score { color: var(--color-success); }
        .score-C .scorecard-score { color: var(--color-warning); }
        .score-D .scorecard-score, .score-F .scorecard-score { color: var(--color-failure); }


        /* ---------------------- ANALYSIS SECTION STYLES ---------------------- */
        .analysis-section {
            margin-top: 3em;
            padding: 30px;
            border-radius: 12px;
            background: var(--color-surface-light);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .analysis-list {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        .analysis-list li {
            padding: 15px 20px;
            background-color: var(--color-surface);
            border-left: 5px solid var(--color-warning); /* Default warning for findings */
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1em;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .analysis-list strong {
            font-size: 1.3em;
            color: var(--color-failure); /* Highlight the percentage with failure color */
        }
        .recommendation-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        .recommendation-list li {
            padding: 15px 20px;
            border-left: 5px solid var(--color-success);
            background-color: var(--color-surface);
            margin-bottom: 10px;
            border-radius: 8px;
            font-weight: 500;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }


        /* ---------------------- CHARTS & TABLE ---------------------- */
        .charts { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: space-between; 
            gap: 30px; 
            margin-top: 3em; 
        }
        .chart-container { 
            flex: 1 1 45%;
            min-width: 300px;
            padding: 2em;
            background: var(--color-surface);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        table { 
            width: 100%; 
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5em; 
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        th, td { 
            border: none;
            border-bottom: 1px solid var(--color-border);
            padding: 15px 12px; 
            text-align: left; 
        }
        th { 
            background-color: var(--color-primary); 
            color: var(--color-surface);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            position: sticky;
            top: 0;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) {
            background-color: var(--color-surface-light);
        }
        tr:hover {
            background-color: var(--color-border);
        }
        pre { 
            background: var(--color-surface-light); 
            padding: 1.5em; 
            border-radius: 8px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        /* ---------------------- STATUS COLORS ---------------------- */
        .status-text {
            font-weight: 700;
            padding: 0.4em 1em; /* Slightly larger padding */
            border-radius: 8px; /* Slightly more rounded */
            display: inline-block;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        .status-SUCCESS {
            color: var(--color-success);
            background-color: rgba(76, 175, 80, 0.1); /* Lighter background tint */
        }
        .status-FAILURE {
            color: var(--color-failure);
            background-color: rgba(229, 57, 53, 0.1);
        }
        .status-PENDING, .status-RUNNING, .status-PROGRESS {
            color: var(--color-warning);
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        /* ---------------------- MEDIA QUERIES ---------------------- */
        @media (max-width: 1024px) {
            .container { padding: 30px; }
            .charts { gap: 20px; }
            .chart-container { flex: 1 1 100%; }
        }
        @media (max-width: 768px) {
            .container { padding: 25px; }
            h1 { font-size: 2em; padding-bottom: 0.3em; }
            h2 { margin-top: 1.5em; font-size: 1.4em;}
            .metric { padding: 1.5em; text-align: left; border-left: 3px solid var(--color-primary); }
            .metrics { grid-template-columns: 1fr; }
            .charts { flex-direction: column; gap: 20px; }
            .chart-container { min-width: 100%; }
            .analysis-list { grid-template-columns: 1fr; }
            .scorecard { flex-direction: column; text-align: center; border-left-width: 5px; padding: 20px;}
            .scorecard-header h2 { text-align: center; }
            .scorecard-summary { text-align: center; margin-top: 15px; margin-left: 0; }
            .scorecard-score { font-size: 4em; }
            .theme-switch-wrapper { top: 15px; right: 15px; }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    {% if job.status == 'PENDING' or job.status == 'RUNNING' or job.status == 'PROGRESS' %}
        <meta http-equiv="refresh" content="5"> 
    {% endif %}
</head>
<body>
    <div class="theme-switch-wrapper">
        <label for="theme-switch">Dark Mode</label>
        <label class="theme-switch" for="theme-switch">
            <input type="checkbox" id="theme-switch" />
            <div class="slider round"></div>
        </label>
    </div>

    <div class="container">
        <h1>Audit Report <span style="color: var(--color-primary);">for Task {{ job.task_id }}</span></h1>
        
        <p><strong>Status:</strong> 
            <span class="status-text status-{{ job.status }}">{{ job.status }}</span>
        </p>

        {% if job.status == 'SUCCESS' and job.result_data.summary %}
            {% if job.result_data.security_analysis %}
            <div class="scorecard" id="scorecard-display">
                <div class="scorecard-header">
                    <h2 style="margin-top: 0; padding-bottom: 0; border-bottom: none;">Overall Password Security Grade</h2>
                    <p style="color: var(--color-text-secondary); margin-bottom: 0;">Based on Entropy and Policy Compliance across all **{{ job.result_data.security_analysis.total_audited }}** hashes.</p>
                </div>
                <div class="scorecard-summary">
                    <h1 class="scorecard-score">{{ job.result_data.security_analysis.security_score }}</h1>
                    <p>Average Password Entropy: <strong style="color: var(--color-text);">{{ job.result_data.security_analysis.average_entropy }} bits</strong></p>
                </div>
            </div>
            {% endif %}
            
            <div class="metrics">
                <div class="metric">
                    <h3>Total Hashes Audited</h3>
                    <div class="value">{{ job.result_data.summary.total_hashes }}</div>
                </div>
                <div class="metric metric-cracked">
                    <h3>Passwords Cracked</h3>
                    <div class="value">{{ job.result_data.summary.cracked_count }}</div>
                </div>
                <div class="metric">
                    <h3>Crack Rate</h3>
                    <div class="value">{{ job.result_data.summary.crack_rate_percent }}%</div>
                </div>
            </div>
            
            {% if job.result_data.security_analysis.violations_by_policy %}
            <div class="analysis-section" style="margin-top: 2em;">
                <h2>Policy Compliance Report 📜</h2>
                <p style="color: var(--color-text-secondary);">Summary of compliance failures among the **{{ job.result_data.security_analysis.total_audited }}** audited hashes.</p>
                
                <table class="violation-table">
                    <thead>
                        <tr>
                            <th>Policy Violation Type</th>
                            <th>Count of Failures</th>
                            <th>Percentage of Total Hashes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for policy, count in job.result_data.security_analysis.violations_by_policy.items() %}
                        <tr>
                            <td>{{ policy }}</td>
                            <td><strong style="color: var(--color-failure);">{{ count }}</strong></td>
                            <td>{{ "%.2f" | format((count / job.result_data.security_analysis.total_audited) * 100) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
            {% if job.result_data.analysis %}
            <div class="analysis-section">
                <h2>Security Analysis & Findings 💡</h2>
                <p style="color: var(--color-text-secondary);">The following common patterns were found among the **{{ job.result_data.summary.cracked_count }}** cracked passwords:</p>
                
                <ul class="analysis-list">
                    <li>
                        <span>Passwords containing **Company Name** (e.g., SecureCorp):</span>
                        <strong>{{ job.result_data.analysis.common_patterns.contains_company_name_percent }}%</strong>
                    </li>
                    <li>
                        <span>Passwords ending with a **Year** (e.g., 2024):</span>
                        <strong>{{ job.result_data.analysis.common_patterns.ends_with_year_percent }}%</strong>
                    </li>
                    <li>
                        <span>Passwords that are **All Lowercase**:</span>
                        <strong>{{ job.result_data.analysis.common_patterns.is_all_lowercase_percent }}%</strong>
                    </li>
                </ul>
                
                <h3>High-Level Recommendations</h3>
                <ul class="recommendation-list">
                    {% for rec in job.result_data.analysis.recommendations %}
                        <li>{{ rec }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if job.result_data.analysis and job.result_data.analysis.vulnerability_classification %}
            <div class="analysis-section">
                <h2>Vulnerability Classification</h2>
                <p style="color: var(--color-text-secondary);">Breakdown of the types of weaknesses found among the <strong>{{ job.result_data.summary.cracked_count }}</strong> cracked passwords:</p>
                <table>
                    <thead>
                        <tr><th>Vulnerability Type</th><th>Count</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>PII / Company Info Related</td>
                            <td>{{ job.result_data.analysis.vulnerability_classification.PII_Company_Info }}</td>
                        </tr>
                        <tr>
                            <td>Sequential / Predictable (e.g., password123)</td>
                            <td>{{ job.result_data.analysis.vulnerability_classification.Sequential_Predictable }}</td>
                        </tr>
                        <tr>
                            <td>Keyboard Patterns (e.g., qwerty)</td>
                            <td>{{ job.result_data.analysis.vulnerability_classification.Keyboard_Patterns }}</td>
                        </tr>
                         <tr>
                            <td>Other Weak Passwords</td>
                            <td>{{ job.result_data.analysis.vulnerability_classification.Other_Weak }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            {% endif %}

            {% if job.result_data.top_offenders %}
            <div class="analysis-section">
                <h2>Top 5 Most Common Cracked Passwords</h2>
                <table>
                    <thead>
                        <tr><th>Password</th><th>Times Found</th></tr>
                    </thead>
                    <tbody>
                        {% for item in job.result_data.top_offenders %}
                        <tr>
                            <td>{{ item.password }}</td>
                            <td>{{ item.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
            
            <div class="charts">
                <div class="chart-container">
                    <h3>Time to Crack Benchmark (Seconds)</h3>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Vulnerability Classification</h3>
                    <canvas id="vulnerabilityChart"></canvas>
                </div>
            </div>

            <div class="analysis-section" style="margin-top: 2em;"> <h3>Cracked Password Entropy Distribution (Bits)</h3>
                <div style="max-width: 600px; margin: auto;"> <canvas id="entropyChart"></canvas>
                </div>
            </div>

            <h3>Detailed Cracked Hash Table</h3>
            <table>
                <thead>
                    <tr><th>User</th><th>Cracked Password</th><th>Hash Type</th></tr>
                </thead>
                <tbody>
                    {% for item in job.result_data.cracked_passwords %}
                        <tr>
                            <td>{{ item.user }}</td>
                            <td>{{ item.password }}</td>
                            <td>{{ item.hash_type }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if job.result_data.analysis %}
            <div class="analysis-section"> <h2>High-Level Recommendations</h2>
                <ul class="recommendation-list">
                    {% for rec in job.result_data.analysis.recommendations %}
                        <li>{{ rec }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <script>
                // This script block should only run if job.status == 'SUCCESS'
                const reportData = {{ job.result_data | tojson }};
                let performanceChart, vulnerabilityChart, entropyChart;

                // --- ADD THIS LOG ---
                console.log("Full Report Data Received by JS:", reportData); 
                // --- END LOG ---

                function getThemeColors() {
                    const isDark = document.body.getAttribute('data-theme') === 'dark';
                    const rootStyles = getComputedStyle(document.documentElement);
                    return {
                        textColor: isDark ? rootStyles.getPropertyValue('--color-text-secondary') : rootStyles.getPropertyValue('--color-text'),
                        gridColor: isDark ? rootStyles.getPropertyValue('--color-border') : rootStyles.getPropertyValue('--color-border'),
                        barColor: isDark ? rootStyles.getPropertyValue('--color-primary') : 'rgba(30, 136, 229, 0.8)',
                        doughnutColors: ['#4285F4', '#DB4437', '#F4B400', '#0F9D58', '#AB47BC'], // Fixed colors for contrast
                        pieColors: ['#DB4437', '#FF9800', '#F4B400', '#757575']
                    };
                }

                function initCharts() {
                    const colors = getThemeColors();
                    
                    // --- Performance Bar Chart ---
                    const perfCtx = document.getElementById('performanceChart').getContext('2d');
                    const perfData = reportData.performance_benchmark;

                    // --- ADD THESE LOGS ---
                    console.log("Performance Benchmark Data for Chart:", perfData); 
                    if (perfData && typeof perfData === 'object') { // Check if it's an object
                        console.log("Performance Labels:", Object.keys(perfData));
                        console.log("Performance Values:", Object.values(perfData));
                        // Check if values are actually numbers
                        console.log("Performance Values are Numbers:", Object.values(perfData).every(v => typeof v === 'number' && isFinite(v)));
                    } else {
                        console.log("Performance Benchmark data is missing, not an object, or empty!");
                    }
                    // --- END LOGS ---
                    

                    if (perfData && typeof perfData === 'object' && Object.keys(perfData).length > 0) { 
                performanceChart = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(perfData),
                    datasets: [{
                        label: 'Time in Seconds',
                        // Filter out non-numeric data just in case
                        data: Object.values(perfData).map(v => (typeof v === 'number' && isFinite(v)) ? v : 0), 
                        backgroundColor: colors.barColor,
                        borderColor: colors.barColor.replace('0.8', '1'),
                        borderWidth: 1
                    }]
                },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: { legend: { labels: { color: colors.textColor } } }
                        }
                    });
        } else {
            console.error("Cannot create Performance Chart: Data is missing, empty, or invalid.");
            // Optionally display a message on the page
            perfCtx.font = "16px Inter";
            perfCtx.fillStyle = getThemeColors().textColor; // Use theme color
            perfCtx.textAlign = "center";
            perfCtx.fillText("No benchmark data available to display.", perfCtx.canvas.width / 2, 50);
        }

        const vulnCtx = document.getElementById('vulnerabilityChart').getContext('2d');
                    const vulnData = reportData.analysis ? reportData.analysis.vulnerability_classification : null; // Get data

                    console.log("Vulnerability Classification Data:", vulnData); // Log data

                    if (vulnData && typeof vulnData === 'object' && Object.keys(vulnData).length > 0) {
                        const labels = Object.keys(vulnData).map(key => key.replace(/_/g, ' ')); // Make labels readable
                        const dataValues = Object.values(vulnData);

                        console.log("Vulnerability Labels:", labels);
                        console.log("Vulnerability Values:", dataValues);

                        // Only create chart if there's data to show
                        if (dataValues.some(v => v > 0)) {
                           vulnerabilityChart = new Chart(vulnCtx, {
                                type: 'doughnut', // Or 'pie'
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Count',
                                        data: dataValues,
                                        backgroundColor: colors.pieColors // Use defined colors
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: true,
                                    plugins: {
                                        legend: {
                                            position: 'top', // Position legend nicely
                                            labels: { color: colors.textColor }
                                        }
                                    }
                                }
                            });
                        } else {
                             console.log("No vulnerability data found (all counts are zero).");
                             vulnCtx.font = "16px Inter"; vulnCtx.fillStyle = colors.textColor; vulnCtx.textAlign = "center";
                             vulnCtx.fillText("No vulnerability classifications found.", vulnCtx.canvas.width / 2, 50);
                        }
                    } else {
                        console.error("Cannot create Vulnerability Chart: Data is missing or invalid.");
                        vulnCtx.font = "16px Inter"; vulnCtx.fillStyle = colors.textColor; vulnCtx.textAlign = "center";
                        vulnCtx.fillText("Vulnerability data not available.", vulnCtx.canvas.width / 2, 50);
                    }

                    const entropyCtx = document.getElementById('entropyChart').getContext('2d');
                    const crackedPasswords = reportData.cracked_passwords || [];
                    console.log("Cracked Passwords for Entropy:", crackedPasswords);

                    if (crackedPasswords.length > 0) {
                        // Define entropy ranges/bins
                        const entropyBins = {
                            "Very Weak (0-3)": 0,
                            "Weak (3-4)": 0,
                            "Moderate (4-6)": 0,
                            "Strong (6+)": 0
                        };
                        const binLabels = Object.keys(entropyBins);

                        // Categorize each password's entropy
                        crackedPasswords.forEach(item => {
                            const entropy = item.entropy; // Assumes entropy is calculated and stored
                            if (typeof entropy === 'number') {
                                if (entropy < 3) entropyBins["Very Weak (0-3)"]++;
                                else if (entropy < 4) entropyBins["Weak (3-4)"]++;
                                else if (entropy < 6) entropyBins["Moderate (4-6)"]++;
                                else entropyBins["Strong (6+)"]++;
                            }
                        });

                        const entropyDataValues = Object.values(entropyBins);
                        console.log("Entropy Bins:", entropyBins);

                        entropyChart = new Chart(entropyCtx, {
                            type: 'bar',
                            data: {
                                labels: binLabels,
                                datasets: [{
                                    label: 'Number of Cracked Passwords',
                                    data: entropyDataValues,
                                    backgroundColor: [ // Different colors for strength
                                        colors.pieColors[1], // Red for Very Weak
                                        colors.pieColors[2], // Yellow for Weak
                                        colors.pieColors[0], // Blue for Moderate
                                        colors.pieColors[3]  // Green for Strong
                                    ],
                                    borderColor: colors.pieColors.map(c => c.replace('0.8', '1')),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                indexAxis: 'y', // Makes it a horizontal bar chart - easier to read labels
                                responsive: true,
                                maintainAspectRatio: true, // Adjust as needed
                                scales: {
                                    x: { // Now X axis is the count
                                        beginAtZero: true,
                                        grid: { color: colors.gridColor },
                                        ticks: { color: colors.textColor }
                                    },
                                    y: { // Y axis is the category
                                        grid: { display: false },
                                        ticks: { color: colors.textColor }
                                    }
                                },
                                plugins: {
                                    legend: { display: false } // Hide legend, labels are clear
                                }
                            }
                        });
                    } else {
                        console.error("Cannot create Entropy Chart: No cracked password data available.");
                        entropyCtx.font = "16px Inter"; entropyCtx.fillStyle = colors.textColor; entropyCtx.textAlign = "center";
                        entropyCtx.fillText("No entropy data available.", entropyCtx.canvas.width / 2, 50);
                    }
                }     
    
                
                function updateChartTheme(chart) {
                    if (!chart) return;
                    const colors = getThemeColors();

                    if (chart.options.scales) {
                        if (chart.options.scales.y) {
                            chart.options.scales.y.grid.color = colors.gridColor;
                            chart.options.scales.y.ticks.color = colors.textColor;
                        }
                        if (chart.options.scales.x) {
                            chart.options.scales.x.ticks.color = colors.textColor;
                        }
                    }
                    if (chart.options.plugins && chart.options.plugins.legend) {
                        chart.options.plugins.legend.labels.color = colors.textColor;
                    }

                    // Update bar chart specific colors
                    if (chart.config.type === 'bar' && chart.data.datasets.length > 0) {
                        chart.data.datasets[0].backgroundColor = colors.barColor;
                        chart.data.datasets[0].borderColor = colors.barColor.replace('0.8', '1');
                    }
                    
                    if (chart.config.type === 'doughnut' && chart.options.plugins.legend) {
                       chart.options.plugins.legend.labels.color = colors.textColor;
                    }

                    chart.update();
                }
                
                document.getElementById('theme-switch').addEventListener('change', () => {
                setTimeout(() => {
                    updateChartTheme(performanceChart); // Only update performanceChart
                }, 100);
            });

                // --- Security Score dynamic class application ---
                document.addEventListener('DOMContentLoaded', () => {
                    const scoreElement = document.getElementById('scorecard-display');
                    if (scoreElement && reportData.security_analysis && reportData.security_analysis.security_score) {
                        const fullScore = reportData.security_analysis.security_score; 
                        const gradeLetter = fullScore.charAt(0); 
                        scoreElement.classList.add(`score-${gradeLetter}`);
                    }
                    // Initialize charts after DOM is loaded
                    initCharts();
                });
                
                // Theme switch listener now calls update on existing charts
                document.getElementById('theme-switch').addEventListener('change', () => {
                    setTimeout(() => {
                        updateChartTheme(performanceChart);
                        updateChartTheme(vulnerabilityChart); // Add update for new chart
                        updateChartTheme(entropyChart); // Add update for new chart
                    }, 100);
                });
            </script>

        {% elif job.status == 'FAILURE' %}
            <h2 style="color: var(--color-failure);">Task Failed 🚨</h2>
            <p>An error occurred during the audit process. Please check the logs below.</p>
            <pre><code>{{ job.result_data }}</code></pre>
            
        {% else %}
            <div class="running-status">
                <h2>Audit Running... <div class="spinner"></div></h2>
            </div>
            <p style="color: var(--color-text-secondary);">Your task is currently being processed by the worker. This page will **refresh automatically** every 5 seconds until the audit is complete.</p>
        {% endif %}

        <a href="/" class="button">Run Another Audit</a>
    </div>

    <script>
        // Global theme script
        const STORAGE_KEY = 'user-theme';
        const body = document.body;
        const themeSwitch = document.getElementById('theme-switch');

        function setTheme(theme) {
            body.setAttribute('data-theme', theme);
            localStorage.setItem(STORAGE_KEY, theme);
            themeSwitch.checked = (theme === 'dark');
        }

        const storedTheme = localStorage.getItem(STORAGE_KEY);
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (storedTheme) {
            setTheme(storedTheme);
        } else if (prefersDark) {
            setTheme('dark');
        } else {
            setTheme('light');
        }

        // The theme switch listener for charts is in the success-only script block
        if (!themeSwitch.hasListener) {
            themeSwitch.addEventListener('change', (e) => {
                setTheme(e.target.checked ? 'dark' : 'light');
            });
            themeSwitch.hasListener = true; // Prevents double-registration
        }
    </script>
</body>
</html>